# 외부에 AAP 데이터베이스 설치

## 1. PostgreSQL 데이터베이스 설치

### 1.1 AAP를 위한 DB 이미지 가져오기 

이미지를 로컬 파일시스템에서 가져오기
```bash
podman load -i ~/temp/ansible-setup/bundle/images/postgresql-15.tar.gz 
podman images
```
* 글로벌 레지스트리 혹은 로컬 레지스트리 등에서 가져올 수 있음

실행 결과
```
[shadowman@aap-db ~]$ podman load -i ~/temp/ansible-setup/bundle/images/postgresql-15.tar.gz 
Getting image source signatures
Copying blob 64d064da291c done   | 
Copying blob 4493ee5cf8cf done   | 
Copying blob 8a15e950eb63 done   | 
Copying config 2392b56e6b done   | 
Writing manifest to image destination
Loaded image: registry.redhat.io/rhel8/postgresql-15:latest

[shadowman@aap-db ~]$ podman images
REPOSITORY                              TAG         IMAGE ID      CREATED      SIZE
registry.redhat.io/rhel8/postgresql-15  latest      2392b56e6b5e  11 days ago  525 MB

[shadowman@aap-db ~]$ 
```
<br>

### 1.2 PostgreSQL 컨테이너 생성

~/create-pgsql-for-aap.sh 파일
```bash
# 
# Create PostgreSQL container for AAP-DB
#

# Global Env
#
DB_USER=postgres
DB_PASSWD=redhat
ADMIN_PASSWD=redhat

# Create & Start
#
podman run -d --name postgresql \
   -e POSTGRESQL_ADMIN_PASSWORD=$ADMIN_PASSWD \
   -p 5432:5432 \
   registry.redhat.io/rhel8/postgresql-15
#-v $QUAY/pgsql-quay:/var/lib/pgsql/data:Z \
```

다음 명령어를 실행
```bash
~/create-pgsql-for-aap.sh 
podman ps
```

실행 결과
```
[shadowman@aap-db ~]$ ~/create-pgsql-for-aap.sh 
037aba7967ba5df2c7b1ef30063e84c2dc9e31e575342d3921ba0d3cb1081bd8

[shadowman@aap-db ~]$ podman ps
CONTAINER ID  IMAGE                                          COMMAND         CREATED         STATUS        PORTS                   NAMES
d1df45b76621  registry.redhat.io/rhel8/postgresql-15:latest  run-postgresql  25 minutes ago  Up 7 minutes  0.0.0.0:5432->5432/tcp  postgresql

[shadowman@aap-db ~]$
```
<br>
<br>

## 2. PostgreSQL 컨테이너를 사용자 서비스로 구성

### 2.1 AAP 사용자 서비스로 구성을 위한 파일 생성

서비스 파일 생성
```bash
podman ps -a
podman generate systemd --new --files --name postgresql
ls -lh /home/shadowman/container-postgresql.service 
cat ~/container-postgresql.service 
```

실행 결과
```
[shadowman@aap-db ~]$ podman ps -a
CONTAINER ID  IMAGE                                          COMMAND         CREATED         STATUS        PORTS                   NAMES
d1df45b76621  registry.redhat.io/rhel8/postgresql-15:latest  run-postgresql  25 minutes ago  Up 7 minutes  0.0.0.0:5432->5432/tcp  postgresql

[shadowman@aap-db ~]$ podman generate systemd --new --files --name postgresql

DEPRECATED command:
It is recommended to use Quadlets for running containers and pods under systemd.

Please refer to podman-systemd.unit(5) for details.
/home/shadowman/container-postgresql.service

[shadowman@aap-db ~]$ ls -lh ~/container-postgresql.service 
-rw-r--r--. 1 shadowman shadowman 833 Oct 16 13:44 /home/shadowman/container-postgresql.service

[shadowman@aap-db ~]$ cat ~/container-postgresql.service 
...<snip>...

[shadowman@aap-db ~]$
```

~/container-postgresql.service 파일
```bash
# container-postgresql.service
# autogenerated by Podman 4.9.4-rhel
# Wed Oct 16 13:44:12 KST 2024

[Unit]
Description=Podman container-postgresql.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman run \
	--cidfile=%t/%n.ctr-id \
	--cgroups=no-conmon \
	--rm \
	--sdnotify=conmon \
	--replace \
	-d \
	--name postgresql \
	-e POSTGRESQL_ADMIN_PASSWORD=redhat \
	-p 5432:5432 registry.redhat.io/rhel8/postgresql-15
ExecStop=/usr/bin/podman stop \
	--ignore -t 10 \
	--cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm \
	-f \
	--ignore -t 10 \
	--cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
```
<br>

### 2.2 PostgreSQL 컨테이너 서비스 구성

AAP 사용자의 서비스로 구성 후 systemd 리로드
```bash
mkdir -pv ~/.config/systemd/user/
cp -rp container-postgresql.service ~/.config/systemd/user/
ls -lh ~/.config/systemd/user/container-postgresql.service 
systemctl --user daemon-reload
```

실행 결과
```
[shadowman@aap-db ~]$ mkdir -pv ~/.config/systemd/user/
mkdir: created directory '/home/shadowman/.config/systemd'
mkdir: created directory '/home/shadowman/.config/systemd/user/'

[shadowman@aap-db ~]$ cp -rp container-postgresql.service ~/.config/systemd/user/

[shadowman@aap-db ~]$ ls -lh ~/.config/systemd/user/container-postgresql.service 
-rw-r--r--. 1 shadowman shadowman 833 Oct 16 13:44 /home/shadowman/.config/systemd/user/container-postgresql.service

[shadowman@aap-db ~]$ systemctl --user daemon-reload

[shadowman@aap-db ~]$
```
<br>

### 2.3 systemd의 사용자 서비스 구성 테스트

#### 2.3.1 서비스 시작 

```bash
systemctl --user start container-postgresql.service
podman ps
systemctl  --user status container-postgresql.service 
```

실행 결과
```
[shadowman@aap-db ~]$ systemctl --user start container-postgresql.service

[shadowman@aap-db ~]$ podman ps
CONTAINER ID  IMAGE                                          COMMAND         CREATED        STATUS        PORTS                   NAMES
0ac8bcaecf73  registry.redhat.io/rhel8/postgresql-15:latest  run-postgresql  2 seconds ago  Up 3 seconds  0.0.0.0:5432->5432/tcp  postgresql

[shadowman@aap-db ~]$ systemctl  --user status container-postgresql.service 
● container-postgresql.service - Podman container-postgresql.service
     Loaded: loaded (/home/shadowman/.config/systemd/user/container-postgresql.service; enabled; preset: disabled)
     Active: active (running) since Wed 2024-10-16 13:49:58 KST; 15s ago
       Docs: man:podman-generate-systemd(1)
   Main PID: 5328 (conmon)
      Tasks: 15 (limit: 23036)
     Memory: 14.8M
        CPU: 105ms
     CGroup: /user.slice/user-1001.slice/user@1001.service/app.slice/container-postgresql.service
             ├─5311 /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp --enable-ipv6 -c -r 3 -e >
             ├─5314 rootlessport
             ├─5319 rootlessport-child
             └─5328 /usr/bin/conmon --api-version 1 -c 0ac8bcaecf7387942d5697841151b58938df668ca86170cb571ec7f1280aa962 -u 0ac8bcaecf738>

[shadowman@aap-db ~]$
```

#### 2.3.2 서비스 종료

```bash
systemctl --user stop container-postgresql.service
podman ps
systemctl  --user status container-postgresql.service 
```

실행 결과
```
[shadowman@aap-db ~]$ systemctl --user stop container-postgresql.service

[shadowman@aap-db ~]$ podman ps
CONTAINER ID  IMAGE       COMMAND     CREATED     STATUS      PORTS       NAMES

[shadowman@aap-db ~]$ systemctl  --user status container-postgresql.service 
○ container-postgresql.service - Podman container-postgresql.service
     Loaded: loaded (/home/shadowman/.config/systemd/user/container-postgresql.service; enabled; preset: disabled)
     Active: inactive (dead) since Wed 2024-10-16 13:50:23 KST; 5s ago
   Duration: 24.101s
       Docs: man:podman-generate-systemd(1)
    Process: 5328 ExecStart=/usr/bin/podman run --cidfile=/run/user/1001/container-postgresql.service.ctr-id --cgroups=no-conmon --rm -->
    Process: 5398 ExecStop=/usr/bin/podman stop --ignore -t 10 --cidfile=/run/user/1001/container-postgresql.service.ctr-id (code=exited>
    Process: 5416 ExecStopPost=/usr/bin/podman rm -f --ignore -t 10 --cidfile=/run/user/1001/container-postgresql.service.ctr-id (code=e>
   Main PID: 5328 (code=exited, status=0/SUCCESS)
        CPU: 262ms

[shadowman@aap-db ~]$ 
```
<br>
<br>

## 3. AAP 서비스 확인

### 3.1 방화벽 구성

```bash
sudo firewall-cmd --list-all
sudo firewall-cmd --permanent --zone=public --add-service=postgresql
sudo firewall-cmd --reload
sudo firewall-cmd --list-all
```

실행 결과
```
[shadowman@aap-db ~]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens3 ens8
  sources: 
  services: cockpit dhcpv6-client ssh
  ports: 
  protocols: 
  forward: yes
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 

[shadowman@aap-db ~]$ sudo firewall-cmd --permanent --zone=public --add-service=postgresql
success

[shadowman@aap-db ~]$ sudo firewall-cmd --reload
success

[shadowman@aap-db ~]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: ens3 ens8
  sources: 
  services: cockpit dhcpv6-client postgresql ssh
  ports: 
  protocols: 
  forward: yes
  masquerade: no
  forward-ports: 
  source-ports: 
  icmp-blocks: 
  rich rules: 

[shadowman@aap-db ~]$
```
<br>

### 3.2 PostgreSQL 연결 테스트

#### 3.2.1 로컬 호스트에서 테스트

```bash
podman port postgresql
psql --username=postgres --host=aap-db
\q
```

실행 결과
```
[shadowman@aap-db ~]$ podman port postgresql
5432/tcp -> 0.0.0.0:5432

[shadowman@aap-db ~]$ psql --username=postgres --host=aap-db
Password for user postgres: 
psql (13.16, server 15.8)
WARNING: psql major version 13, server major version 15.
         Some psql features might not work.
Type "help" for help.

postgres=# \q

[shadowman@aap-db ~]$
```

#### 3.2.2 원격 호스트에서 테스트

실행 결과
```
[shadowman@aap-c1 ~]$ psql --username=postgres --host=aap-db
Password for user postgres: 
psql (13.16, server 15.8)
WARNING: psql major version 13, server major version 15.
         Some psql features might not work.
Type "help" for help.

postgres=# \q

[shadowman@aap-c1 ~]$ 
```
<br>
<br>

